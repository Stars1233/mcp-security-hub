# Offensive Security MCP Servers - Docker Compose
#
# Usage:
#   docker-compose up -d                    # Start all services
#   docker-compose up nuclei-mcp -d         # Start specific service
#   docker-compose logs -f nuclei-mcp       # View logs
#   docker-compose down                     # Stop all services
#
# Security Notes:
#   - All containers run as non-root (uid 1000)
#   - Network isolation via dedicated bridge network
#   - Read-only filesystems where possible
#   - Capabilities dropped by default

version: '3.8'

services:
  # ===========================================================================
  # Reconnaissance
  # ===========================================================================
  nmap-mcp:
    build:
      context: ./reconnaissance/nmap-mcp
      dockerfile: Dockerfile
    image: ghcr.io/fuzzinglabs/nmap-mcp:latest
    container_name: nmap-mcp
    ports:
      - "3001:3000"
    networks:
      - mcp-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_RAW      # Required for raw socket scanning
      - NET_ADMIN    # Required for some scan types
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

  shodan-mcp:
    build:
      context: ./reconnaissance/shodan-mcp
      dockerfile: Dockerfile
    image: ghcr.io/fuzzinglabs/shodan-mcp:latest
    container_name: shodan-mcp
    environment:
      - SHODAN_API_KEY=${SHODAN_API_KEY:-}
    ports:
      - "3002:3000"
    networks:
      - mcp-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=64M
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  pd-tools-mcp:
    build:
      context: ./reconnaissance/pd-tools-mcp
      dockerfile: Dockerfile
    image: ghcr.io/fuzzinglabs/pd-tools-mcp:latest
    container_name: pd-tools-mcp
    ports:
      - "3009:3000"
    networks:
      - mcp-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  whatweb-mcp:
    build:
      context: ./reconnaissance/whatweb-mcp
      dockerfile: Dockerfile
    image: ghcr.io/fuzzinglabs/whatweb-mcp:latest
    container_name: whatweb-mcp
    environment:
      - WHATWEB_OUTPUT_DIR=/app/output
      - WHATWEB_TIMEOUT=${WHATWEB_TIMEOUT:-300}
    volumes:
      - whatweb-output:/app/output
    ports:
      - "3016:3000"
    networks:
      - mcp-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

  masscan-mcp:
    build:
      context: ./reconnaissance/masscan-mcp
      dockerfile: Dockerfile
    image: ghcr.io/fuzzinglabs/masscan-mcp:latest
    container_name: masscan-mcp
    environment:
      - MASSCAN_OUTPUT_DIR=/app/output
      - MASSCAN_TIMEOUT=${MASSCAN_TIMEOUT:-300}
      - MASSCAN_MAX_RATE=${MASSCAN_MAX_RATE:-10000}
    volumes:
      - masscan-output:/app/output
    ports:
      - "3017:3000"
    networks:
      - mcp-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_RAW      # Required for raw socket scanning
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G

  # ===========================================================================
  # Web Security
  # ===========================================================================
  nuclei-mcp:
    build:
      context: ./web-security/nuclei-mcp
      dockerfile: Dockerfile
    image: ghcr.io/fuzzinglabs/nuclei-mcp:latest
    container_name: nuclei-mcp
    environment:
      - NUCLEI_RATE_LIMIT=${NUCLEI_RATE_LIMIT:-150}
      - NUCLEI_SEVERITY=${NUCLEI_SEVERITY:-critical,high,medium}
      - NUCLEI_TEMPLATES_PATH=/app/templates
      - NUCLEI_OUTPUT_DIR=/app/output
      - NUCLEI_TIMEOUT=${NUCLEI_TIMEOUT:-300}
      - NUCLEI_MAX_CONCURRENT=${NUCLEI_MAX_CONCURRENT:-3}
    volumes:
      - nuclei-templates:/app/templates
      - nuclei-output:/app/output
    ports:
      - "3003:3000"
    networks:
      - mcp-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  sqlmap-mcp:
    build:
      context: ./web-security/sqlmap-mcp
      dockerfile: Dockerfile
    image: ghcr.io/fuzzinglabs/sqlmap-mcp:latest
    container_name: sqlmap-mcp
    environment:
      - SQLMAP_OUTPUT_DIR=/app/output
    volumes:
      - sqlmap-output:/app/output
    ports:
      - "3004:3000"
    networks:
      - mcp-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

  nikto-mcp:
    build:
      context: ./web-security/nikto-mcp
      dockerfile: Dockerfile
    image: ghcr.io/fuzzinglabs/nikto-mcp:latest
    container_name: nikto-mcp
    environment:
      - NIKTO_OUTPUT_DIR=/app/output
      - NIKTO_TIMEOUT=${NIKTO_TIMEOUT:-600}
    volumes:
      - nikto-output:/app/output
    ports:
      - "3010:3000"
    networks:
      - mcp-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

  ffuf-mcp:
    build:
      context: ./web-security/ffuf-mcp
      dockerfile: Dockerfile
    image: ghcr.io/fuzzinglabs/ffuf-mcp:latest
    container_name: ffuf-mcp
    environment:
      - FFUF_OUTPUT_DIR=/app/output
      - FFUF_TIMEOUT=${FFUF_TIMEOUT:-600}
      - FFUF_THREADS=${FFUF_THREADS:-40}
    volumes:
      - ffuf-output:/app/output
      - ffuf-wordlists:/app/wordlists
    ports:
      - "3015:3000"
    networks:
      - mcp-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G

  waybackurls-mcp:
    build:
      context: ./web-security/waybackurls-mcp
      dockerfile: Dockerfile
    image: ghcr.io/fuzzinglabs/waybackurls-mcp:latest
    container_name: waybackurls-mcp
    environment:
      - WAYBACKURLS_OUTPUT_DIR=/app/output
      - WAYBACKURLS_TIMEOUT=${WAYBACKURLS_TIMEOUT:-300}
    volumes:
      - waybackurls-output:/app/output
    ports:
      - "3020:3000"
    networks:
      - mcp-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

  # ===========================================================================
  # Exploitation
  # ===========================================================================
  searchsploit-mcp:
    build:
      context: ./exploitation/searchsploit-mcp
      dockerfile: Dockerfile
    image: ghcr.io/fuzzinglabs/searchsploit-mcp:latest
    container_name: searchsploit-mcp
    environment:
      - SEARCHSPLOIT_OUTPUT_DIR=/app/output
    volumes:
      - searchsploit-output:/app/output
    ports:
      - "3018:3000"
    networks:
      - mcp-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # ===========================================================================
  # Binary Analysis
  # ===========================================================================
  ghidra-mcp:
    build:
      context: ./binary-analysis/ghidra-mcp
      dockerfile: Dockerfile
    image: ghcr.io/fuzzinglabs/ghidra-mcp:latest
    container_name: ghidra-mcp
    environment:
      - GHIDRA_INSTALL_DIR=/opt/ghidra
    volumes:
      - ghidra-projects:/app/projects
      - ghidra-samples:/app/samples:ro
    ports:
      - "3006:3000"
    networks:
      - mcp-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G

  radare2-mcp:
    build:
      context: ./binary-analysis/radare2-mcp
      dockerfile: Dockerfile
    image: ghcr.io/fuzzinglabs/radare2-mcp:latest
    container_name: radare2-mcp
    volumes:
      - radare2-samples:/app/samples:ro
    ports:
      - "3007:3000"
    networks:
      - mcp-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  binwalk-mcp:
    build:
      context: ./binary-analysis/binwalk-mcp
      dockerfile: Dockerfile
    image: ghcr.io/fuzzinglabs/binwalk-mcp:latest
    container_name: binwalk-mcp
    environment:
      - BINWALK_OUTPUT_DIR=/app/output
      - BINWALK_TIMEOUT=${BINWALK_TIMEOUT:-300}
    volumes:
      - binwalk-output:/app/output
      - binwalk-uploads:/app/uploads
    ports:
      - "3012:3000"
    networks:
      - mcp-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  yara-mcp:
    build:
      context: ./binary-analysis/yara-mcp
      dockerfile: Dockerfile
    image: ghcr.io/fuzzinglabs/yara-mcp:latest
    container_name: yara-mcp
    environment:
      - YARA_RULES_DIR=/app/rules
      - YARA_OUTPUT_DIR=/app/output
      - YARA_TIMEOUT=${YARA_TIMEOUT:-300}
    volumes:
      - yara-output:/app/output
      - yara-samples:/app/samples
    ports:
      - "3013:3000"
    networks:
      - mcp-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

  capa-mcp:
    build:
      context: ./binary-analysis/capa-mcp
      dockerfile: Dockerfile
    image: ghcr.io/fuzzinglabs/capa-mcp:latest
    container_name: capa-mcp
    environment:
      - CAPA_OUTPUT_DIR=/app/output
      - CAPA_TIMEOUT=${CAPA_TIMEOUT:-300}
    volumes:
      - capa-output:/app/output
      - capa-samples:/app/samples:ro
    ports:
      - "3019:3000"
    networks:
      - mcp-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ===========================================================================
  # Cloud Security
  # ===========================================================================
  trivy-mcp:
    build:
      context: ./cloud-security/trivy-mcp
      dockerfile: Dockerfile
    image: ghcr.io/fuzzinglabs/trivy-mcp:latest
    container_name: trivy-mcp
    environment:
      - TRIVY_OUTPUT_DIR=/app/output
      - TRIVY_TIMEOUT=${TRIVY_TIMEOUT:-600}
    volumes:
      - trivy-output:/app/output
      - trivy-cache:/home/mcpuser/.cache/trivy
      - /var/run/docker.sock:/var/run/docker.sock:ro  # For local image scanning
    ports:
      - "3011:3000"
    networks:
      - mcp-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  prowler-mcp:
    build:
      context: ./cloud-security/prowler-mcp
      dockerfile: Dockerfile
    image: ghcr.io/fuzzinglabs/prowler-mcp:latest
    container_name: prowler-mcp
    environment:
      - PROWLER_OUTPUT_DIR=/app/output
      - PROWLER_TIMEOUT=${PROWLER_TIMEOUT:-1800}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-1}
    volumes:
      - prowler-output:/app/output
    ports:
      - "3014:3000"
    networks:
      - mcp-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G

# =============================================================================
# Networks
# =============================================================================
networks:
  mcp-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"

# =============================================================================
# Volumes
# =============================================================================
volumes:
  # Nuclei
  nuclei-templates:
    driver: local
  nuclei-output:
    driver: local

  # SQLMap
  sqlmap-output:
    driver: local

  # Nikto
  nikto-output:
    driver: local

  # Ghidra
  ghidra-projects:
    driver: local
  ghidra-samples:
    driver: local

  # Radare2
  radare2-samples:
    driver: local

  # Binwalk
  binwalk-output:
    driver: local
  binwalk-uploads:
    driver: local

  # YARA
  yara-output:
    driver: local
  yara-samples:
    driver: local

  # Trivy
  trivy-output:
    driver: local
  trivy-cache:
    driver: local

  # Prowler
  prowler-output:
    driver: local

  # ffuf
  ffuf-output:
    driver: local
  ffuf-wordlists:
    driver: local

  # WhatWeb
  whatweb-output:
    driver: local

  # Masscan
  masscan-output:
    driver: local

  # SearchSploit
  searchsploit-output:
    driver: local

  # Capa
  capa-output:
    driver: local
  capa-samples:
    driver: local

  # Waybackurls
  waybackurls-output:
    driver: local
